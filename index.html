<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<title>الإذاعة</title>
<style>
body{margin:0;background:#f2f2f2;font-family:Tahoma,Arial,Sans-Serif;font-size:16px;}
.ctr{width:90%;max-width:500px;margin:auto;padding:2%;}
.bx{background:#fff;padding:3%;border-radius:12px;margin-top:2%;box-shadow:0 0.5em 1.5em rgba(0,0,0,0.08);box-sizing:border-box;}
input,textarea{width:100%;padding:1%;margin-top:2%;border-radius:8px;border:1px solid #ccc;font-size:1em;box-sizing:border-box;}
button{padding:1%;border:0;border-radius:8px;background:#007bff;color:#fff;cursor:pointer;margin-top:2%;width:100%;font-size:1em;}
button:hover{background:#005fcc;}
.tl{display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;}
.add{font-size:2em;cursor:pointer;}
.it{padding:2%;border:1px solid #e6e6e6;border-radius:8px;margin-top:2%;cursor:pointer;word-break:break-word;}
.sm{font-size:0.9em;color:#666;margin-top:1%;}
.date-item{display:flex;justify-content:space-between;align-items:center;margin-top:5px;padding:5px;border:1px solid #ccc;border-radius:6px;}
.date-item button{width:auto;padding:0 5px;background:#d00;margin:0;font-size:0.8em;}
.page-row{display:flex;justify-content:space-between;align-items:center;margin-top:5px;padding:6px;border:1px solid #e6e6e6;border-radius:8px;}
.page-row .title{cursor:pointer;flex:1;}
.small-btn{padding:6px 8px;border-radius:6px;border:0;cursor:pointer;margin-left:6px;}
.del-page{background:#d00;color:#fff;}
@media(max-width:500px){
 .tl{flex-direction:column;align-items:flex-start;}
 .add{margin-top:0.5em;}
}
</style>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
</head>
<body>
<div class="ctr">

<!-- تسجيل الدخول -->
<div id="lg" class="bx">
 <h3>تسجيل الدخول</h3>
 <input id="em" placeholder="الإيميل" />
 <input id="pw" type="password" placeholder="كلمة المرور" />
 <button onclick="lgf()">دخول</button>
 <button id="guestBtn" onclick="gst()" style="background:#555">الدخول كزائر</button>
</div>

<!-- قائمة الفقرات -->
<div id="mn" style="display:none">
 <div class="bx">
  <h2 style="text-align:center">الفقرات</h2>
  <div id="plist"></div>
  <div id="addNewPage" style="display:none;margin-top:10px;">
    <input id="newPageName" placeholder="اسم الفقرة الجديدة" />
    <button onclick="addPage()">إضافة فقرة</button>
  </div>
 </div>
</div>

<!-- صفحة الفقرة -->
<div id="pg" style="display:none">
 <div class="bx">
  <div class="tl">
   <h2 id="pgn"></h2>
   <div id="ad" class="add" onclick="opadd()" style="display:none">＋</div>
  </div>
  <div id="st"></div>
  <button onclick="bck()">رجوع</button>
 </div>
</div>

<!-- عرض محتوى الطالب -->
<div id="stp" style="display:none">
 <div class="bx">
  <h2 id="stn"></h2>
  <div id="sti" class="sm"></div>
  <!-- إدخال المواعيد لمحمد هشام فقط -->
  <div id="date-editor" style="margin-top:10px; display:none;">
    <input id="newdate" placeholder="أدخل موعد بصيغة يوم/شهر" />
    <button onclick="addDate()">إضافة موعد</button>
  </div>
  <div id="datesList"></div>
  <button onclick="bck2()" style="margin-top:10px;">رجوع</button>
 </div>
</div>

<!-- إضافة طالب -->
<div id="adp" style="display:none">
 <div class="bx">
  <h3>إضافة طالب</h3>
  <input id="sn" placeholder="اسم الطالب" />
  <input id="se" placeholder="الإيميل" />
  <input id="sp" placeholder="الباسورد" />
  <textarea id="sc" placeholder="محتوى فقرته"></textarea>

  <!-- جديد: إضافة مواعيد واحدة واحدة -->
  <div style="margin-top:8px;">
    <div style="display:flex;gap:6px;">
      <input id="sd_single" placeholder="أدخل موعد (يوم/شهر)" />
      <button id="addSdBtn" onclick="pushTempDate()" style="width:auto;padding:8px;">أضف موعد</button>
    </div>
    <div id="sdList" style="margin-top:8px;"></div>
  </div>

  <button onclick="sav()">إضافة</button>
  <button onclick="bckp()" style="background:#aaa">رجوع</button>
 </div>
</div>

<!-- تعديل طالب -->
<div id="edp" style="display:none">
 <div class="bx ctr">
  <h3>تعديل طالب</h3>
  <input id="esn" placeholder="اسم الطالب" />
  <input id="ese" placeholder="الإيميل" />
  <input id="esp" placeholder="الباسورد" />
  <textarea id="esc" placeholder="محتوى فقرته"></textarea>
  <input id="esd" placeholder="المواعيد مفصولة بفواصل (اليوم/الشهر)" />
  <button onclick="svu()">حفظ التعديل</button>
  <button onclick="bcke()" style="background:#aaa">رجوع</button>
 </div>
</div>

<script>
// Firebase setup
const firebaseConfig = {
 apiKey: "AIzaSyAuNj9CbmYfolZwmviheiwzaW9qYCHEUA8",
 authDomain: "radio-app-7fed6.firebaseapp.com",
 databaseURL: "https://radio-app-7fed6-default-rtdb.firebaseio.com",
 projectId: "radio-app-7fed6",
 storageBucket: "radio-app-7fed6.firebasestorage.app",
 messagingSenderId: "696558044742",
 appId: "1:696558044742:web:3d1935ccd4393431326c47",
 measurementId: "G-JS23NJMVK1"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

const ADM_E="Mohamed.hesham@web", ADM_P="Mohamed.hesham";
let ADM=false;
let curpg="", curst=null, edi="";

// مؤقت لتخزين المواعيد أثناء إضافة طالب واحد-واحد
let tmpDates = [];

// ===== Default names (fallback) =====
const namesFallback={quran:"القرآن",presentation:"التقديم",hikma:"الحكمة",maqal:"المقال",info:"هل تعلم؟",qs:"الأسئلة",hadith:"الحديث",anthem:"النشيد الوطني"};

// ===== Initialize Database defaults if مفقود =====
function init(){
 // تأكد من وجود العقدة pgs
 db.ref('pgs').once('value', snap=>{
   if(!snap.exists()){
     // إنشاء الافتراضيات
     const initObj = {};
     for(const k in namesFallback) initObj[k] = {sts:[], title: namesFallback[k]};
     db.ref('pgs').set(initObj);
   } else {
     // للتأكد: أي صفحة بدون title نضيف title افتراضي
     snap.forEach(child=>{
       if(!child.hasChild('title')){
         const key = child.key;
         const ttl = namesFallback[key] || key;
         db.ref('pgs/'+key+'/title').set(ttl);
       }
     });
   }
 });
}
init();

// ===== Login & Guest =====
function lgf(){
 let e=document.getElementById("em").value.trim(), p=document.getElementById("pw").value.trim();
 if(e===ADM_E && p===ADM_P){
   ADM=true;
   document.getElementById("guestBtn").style.display="none";
   shmn();
   return;
 }
 db.ref('pgs').once('value', snap=>{
   let found=false;
   snap.forEach(page=>{
     page.child('sts').forEach(s=>{
       if(s.val().e===e && s.val().p===p){
         ADM=false;
         curpg=page.key;
         curst={key:s.key,...s.val()};
         document.getElementById("lg").style.display="none";
         document.getElementById("guestBtn").style.display="none";
         showStudentContent();
         found=true;
       }
     });
   });
   if(!found) alert("خطأ في تسجيل الدخول");
 });
}

function gst(){ADM=false; shmn();}

// ===== Show menu (يقرأ الصفحات من DB) =====
function shmn(){
 document.getElementById("lg").style.display="none";
 document.getElementById("mn").style.display="block";
 document.getElementById("plist").innerHTML="";
 // جلب كل الصفحات من DB
 db.ref('pgs').once('value', snap=>{
   snap.forEach(p=>{
     const key = p.key;
     const ttl = (p.val() && p.val().title) ? p.val().title : key;
     const row = document.createElement('div');
     row.className='page-row';
     const tdiv = document.createElement('div');
     tdiv.className='title';
     tdiv.innerText = ttl;
     tdiv.onclick = ()=>op(key);
     row.appendChild(tdiv);

     if(ADM){
       // زر تعديل العنوان (اختياري) — هنا مجرد حذف حسب طلبك
       const delBtn = document.createElement('button');
       delBtn.className='small-btn del-page';
       delBtn.innerText='حذف';
       delBtn.onclick = (ev)=>{ ev.stopPropagation(); delPage(key, ttl); };
       row.appendChild(delBtn);
     }

     document.getElementById('plist').appendChild(row);
   });

   // عرض إضافة صفحة للمدير
   document.getElementById("addNewPage").style.display = ADM ? "block" : "none";
 });
}

// ===== حذف صفحة =====
function delPage(key, title){
 if(!confirm("هل تريد حذف الفقرة '"+title+"'؟ هذه العملية تحذف كل طلابها.")) return;
 db.ref('pgs/'+key).remove().then(()=>{
   // إعادة تحميل القائمة
   shmn();
 }).catch(err=>{ alert("خطأ بالحذف: "+err.message); });
}

// ===== Open page =====
function op(k){
 curpg=k;
 document.getElementById("mn").style.display="none";
 document.getElementById("pg").style.display="block";
 // قراءة عنوان الصفحة من DB
 db.ref('pgs/'+k+'/title').once('value', s=>{
   document.getElementById("pgn").innerText = s.exists() ? s.val() : k;
 });
 document.getElementById("ad").style.display=ADM?"block":"none";
 shsts();
}

// ===== Show students in page =====
function shsts(){
 let cont=document.getElementById("st");  
 cont.innerHTML="";
 db.ref('pgs/'+curpg+'/sts').once('value', snap=>{
   snap.forEach((s)=>{
     let data = s.val();
     let d=document.createElement("div");
     d.className="it";
     let inner = data.n;
     if(ADM) inner += `<br><span style='font-size:13px;'><span style='color:#007bff;cursor:pointer' onclick='edt("${s.key}")'>تعديل</span> | <span style='color:#d00;cursor:pointer' onclick='del("${s.key}")'>حذف</span></span>`;
     d.innerHTML = inner;
     d.onclick=()=>{curst={key:s.key,...data}; showStudentContent();};
     cont.appendChild(d);
   });
 });
}

// ===== Show student content =====
function showStudentContent(){
 document.getElementById("mn").style.display="none";
 document.getElementById("pg").style.display="none";
 document.getElementById("stp").style.display="block";
 document.getElementById("stn").innerText = curst.n;
 document.getElementById("sti").innerHTML = "<b>فقرتك:</b> " + (curst.sectionTitle || "") + "<br><br>" + (curst.c||"-");
 showDates();
 document.getElementById("date-editor").style.display=ADM? "block":"none";
}

// ===== Dates =====
function showDates(){
 let listDiv = document.getElementById("datesList");
 listDiv.innerHTML="";
 if(!curst.dates) curst.dates=[];
 curst.dates.forEach((d,i)=>{
   let div = document.createElement("div");
   div.className="date-item";
   div.innerText = d;
   if(ADM){
     let btn = document.createElement("button");
     btn.innerText="حذف";
     btn.onclick = ()=>{ removeDate(i); };
     div.appendChild(btn);
   }
   listDiv.appendChild(div);
 });
}

function addDate(){
 if(!ADM) return;
 let d=document.getElementById("newdate").value.trim();
 if(!d) return;
 if(!curst.dates) curst.dates=[];
 curst.dates.push(d);
 db.ref('pgs/'+curpg+'/sts/'+curst.key+'/dates').set(curst.dates).then(()=>{
   document.getElementById("newdate").value="";
   showDates();
 }).catch(err=>alert("خطأ بالحفظ: "+err.message));
}

function removeDate(i){
 if(!ADM) return;
 curst.dates.splice(i,1);
 db.ref('pgs/'+curpg+'/sts/'+curst.key+'/dates').set(curst.dates).then(()=> showDates() ).catch(err=>alert("خطأ: "+err.message));
}

// ===== Back buttons =====
function bck(){document.getElementById("pg").style.display="none";document.getElementById("mn").style.display="block";}
function bck2(){document.getElementById("stp").style.display="none";document.getElementById("pg").style.display="block";}

// ===== Add student (فتح النافذة) =====
function opadd(){
 tmpDates = []; // تفريغ المصفوفة المؤقتة
 renderTmpDates();
 document.getElementById("sn").value = document.getElementById("se").value = document.getElementById("sp").value = document.getElementById("sc").value = "";
 document.getElementById("sd_single").value = "";
 document.getElementById("adp").style.display="block";
 document.getElementById("pg").style.display="none";
}
function bckp(){document.getElementById("adp").style.display="none";document.getElementById("pg").style.display="block";}

// مؤقت: إضافة موعد واحد-واحد في واجهة إضافة طالب
function pushTempDate(){
 const v = document.getElementById("sd_single").value.trim();
 if(!v) return;
 tmpDates.push(v);
 document.getElementById("sd_single").value = "";
 renderTmpDates();
}
function renderTmpDates(){
 const box = document.getElementById("sdList");
 box.innerHTML = "";
 if(tmpDates.length===0){ box.innerHTML = "<div class='sm'>لم تُضف مواعيد بعد</div>"; return; }
 tmpDates.forEach((d,i)=>{
   const div = document.createElement('div');
   div.className='date-item';
   div.innerText = d;
   const btn = document.createElement('button');
   btn.innerText = 'حذف';
   btn.onclick = ()=>{ tmpDates.splice(i,1); renderTmpDates(); };
   div.appendChild(btn);
   box.appendChild(div);
 });
}

// ===== Save new student =====
function sav(){
 let s={n:document.getElementById("sn").value.trim(),e:document.getElementById("se").value.trim(),p:document.getElementById("sp").value.trim(),c:document.getElementById("sc").value.trim(),dates: tmpDates.slice()};
 if(!s.n||!s.e||!s.p){alert("املأ الاسم والإيميل والباسورد");return;}
 let newRef = db.ref('pgs/'+curpg+'/sts').push();
 // حفظ عنوان القسم داخل بيانات الطالب (اختياري) ليس ضرورياً لكن مفيد للعرض
 s.sectionTitle = document.getElementById("pgn").innerText || curpg;
 newRef.set(s).then(()=>{
   // مسح الحقول بعد الحفظ
   tmpDates = [];
   renderTmpDates();
   document.getElementById("sn").value=document.getElementById("se").value=document.getElementById("sp").value=document.getElementById("sc").value=document.getElementById("sd_single").value="";
   document.getElementById("adp").style.display="none";
   document.getElementById("pg").style.display="block";
   shsts();
 }).catch(err=>{ alert("خطأ بالحفظ: "+err.message); });
}

// ===== Edit student =====
function edt(key){
 edi=key;
 db.ref('pgs/'+curpg+'/sts/'+key).once('value', snap=>{
   let s = snap.val();
   document.getElementById("esn").value=s.n;
   document.getElementById("ese").value=s.e;
   document.getElementById("esp").value=s.p;
   document.getElementById("esc").value=s.c;
   document.getElementById("esd").value=(s.dates||[]).join(",");
   document.getElementById("pg").style.display="none";
   document.getElementById("edp").style.display="block";
 });
}

function svu(){
 let s={n:document.getElementById("esn").value.trim(),e:document.getElementById("ese").value.trim(),p:document.getElementById("esp").value.trim(),c:document.getElementById("esc").value.trim(),dates:(document.getElementById("esd").value.trim()?document.getElementById("esd").value.trim().split(","):[])};
 db.ref('pgs/'+curpg+'/sts/'+edi).set(s).then(()=>{
   document.getElementById("edp").style.display="none";
   document.getElementById("pg").style.display="block";
   shsts();
 }).catch(err=>alert("خطأ بالحفظ: "+err.message));
}

// ===== Delete student =====
function del(key){if(!confirm("هل تريد حذف هذا الطالب؟")) return; db.ref('pgs/'+curpg+'/sts/'+key).remove().then(()=> shsts() ).catch(err=>alert("خطأ بالحذف: "+err.message));}

// ===== Add new page =====
function addPage(){
 let name=document.getElementById("newPageName").value.trim();
 if(!name) return;
 let pageKey = name.toLowerCase().replace(/\s+/g,"_");
 // أنشئ الصفحة و اكتب title حتى تحفظ
 db.ref('pgs/'+pageKey).set({sts:[], title: name}).then(()=>{
   document.getElementById("newPageName").value="";
   shmn();
 }).catch(err=>alert("خطأ بالحفظ: "+err.message));
}
</script>
</body>
</html>
